## 一页梳理版：RAG 检索增强生成与持续改进

### 0. 前言要点

* 角色转换：你不再输出“记忆里的知识”，你输出“检索到的证据的总结”
* 类比：导游志愿者不熟景点时查手册与地图，大模型配知识库后也能查资料再作答
* 目标：减少幻觉，让答案“可追溯、可核验”
* 方法：**RAG（Retrieval Augmented Generation）= 检索 + 生成**

---

## 课程目标

* 理解：RAG 的定义与实现原理
* 实操：为大模型接入知识库，完成 RAG 问答
* 进阶：掌握常见的 RAG 改进策略框架

---

## 1. 什么是 RAG

### 1.1 导游例子映射

* **系统预置知识库**：志愿者手册（公司统一配置）
* **用户私域知识库**：游客提供的导览图（团队或个人上传的垂直资料）
* 两者共同目标：让回答基于资料，降低“编造式回答”

### 1.2 RAG 的三步骤

1. **建立索引（Indexing）**：准备“可检索的知识库”
2. **检索（Retrieval）**：从知识库找到与问题最相关的片段
3. **生成（Generation）**：把检索片段塞进提示词模板，让模型基于证据生成答案

> 直觉表达：先找资料，再回答。

---

## 2. RAG 的实现原理

### 2.1 建立索引的流水线

* 文档解析：PDF、Docx、网页等 → 纯文本
* 文本分块：切成 chunk（可管理的小片段）
* 向量化：chunk 经 Embedding 模型 → 向量（embedding）
* 存储：chunk 与向量以键值对形式存入向量数据库

### 2.2 检索生成的流程

* 输入：用户问题
* 相似度计算：问题向量 vs 文档块向量
* Top-K：取相似度最高 K 个 chunk 作为证据
* 提示词模板：把“证据块 + 问题”合并喂给大模型生成答案

  * 典型模板：请阅读 {知识文档块}，回答 {用户问题}

---

## 3. RAG 应用案例：阿里云 AI 助理

* 痛点：通用模型不一定懂阿里云产品细节
* 解法：用阿里云产品文档做知识库，形成 RAG 问答
* 输出特点：回答后附参考文档链接，便于校验
* 示例问题：Python SDK 上传 OSS 文件怎么做

---

## 4. 动手实验（课程意图）

* 目标：搭建私域知识问答机器人
* 路线：创建知识库 → 创建基于知识库的 RAG 应用 → 问答测试
* 示例方向：RAG + 钉钉机器人，实现私有知识回答

---

## 5. 扩展：如何持续改进 RAG 应用效果

这里的内容可以整理为一个“问题归因 → 对应改造”的框架。

### 5.1 建立评测标准

评测对象分两层：检索模块与生成模块，也可以端到端。

* 检索指标：准确率、召回率、F1
* 生成指标：相关性、真实性、价值密度
* 实施方式：业务场景题集 + 领域专家评测
* 参考：Ragas 的评测矩阵思路

---

### 5.2 改造一：提升索引与检索准确率

**A. 文本解析优化**

* 去噪：页眉页脚、导航栏、无关脚注
* 保留：正文、表格、关键结构化字段

**B. chunk 切分策略优化**
目标：保持语义完整、减少信息断裂。

* 领域结构切分：法律条款编号、章节标题
* 固定长度切分：实现快，语义可能断裂
* 上下文感知切分：保留前后句，或用语义算法保证连贯
* 动态策略：围绕关键词或主题调整块大小

**C. 句子滑动窗口检索**

* 命中 chunk 后，带上上下文窗口增强证据完整性

**D. 自动合并检索（树结构合并）**

* 多尺度分块（1024, 512, 128）构建树
* 命中同一父节点多个叶子时，返回父节点文本
* 经验结论：常比滑窗更稳

**E. Embedding 模型选型**

* 向量质量决定检索上限
* 中文场景优先考虑中文表现更好的 embedding

**F. ReRank 模型选型**

* 向量检索召回后，ReRank 再排序
* 价值：把真正相关的 chunk 排到更前，提升最终答案质量

**G. Raptor 聚类建索引**

* 无监督聚类生成“目录结构”
* 作用：加速定位与提升可检索性，适合资料缺目录的场景

---

### 5.3 改造二：让问题更好理解（Query Reformulation）

**Enrich 完善用户问题**

* 多轮确认补齐缺失要素
* 生产限制：用户耐心有限，需要终止机制（EOS 等）

**标准化转述后再检索**

* 让模型把口语问题转成规范查询指令
* 可用 few-shot 模板与知识库辅助

**让用户一次性补齐参数**

* 意图识别 → 选择业务模板 → 要求用户补全关键字段
* 适用：订票、订酒店等参数密集型业务

**Multi-Query 多路召回**

* 一次生成多个不同角度的问题版本
* 分别检索，提高召回率

**RAG-Fusion 过滤融合**

* 去重 + 排序后再喂给模型
* 降 token，提质量

**Step-back 问题摘要**

* 先抽象出更通用的“上位问题”，更容易检索到泛化证据

**Decomposition 问题分解**

* 拆成多个子问题检索与回答
* 执行方式：并行汇总或串行递进

**HyDE 假设答案检索**

* 先生成“假设答案”作为检索查询
* 用假设语义去匹配更相关的文档块

---

### 5.4 改造三：改造信息抽取途径（CRAG）

当知识库检索相关性太低时，主动引入外部搜索补强。

* 判定方式 1：相似度阈值
* 判定方式 2：让模型判断“材料是否足够回答”
* 然后：互联网搜索结果 + 知识库结果融合，再生成最终答案

---

### 5.5 改造四：回答前反复思考（Self-RAG）

引入自反思检查点：

* 相关性：材料相关吗
* 无幻觉：答案是否严格依据材料
* 已解答：是否真正回答了问题
  用额外提示词或独立评审链路实现，复杂度上升，可靠性增强。

---

### 5.6 改造五：多数据源检索

把“只检索文本”升级为“检索多种知识形态”：

* **NL2SQL**：自然语言 → SQL → 数据库取数与统计

  * 单表聚合更稳，多表复杂查询更难
  * Spider 常用于评测执行正确率
* **NL2Cypher**：自然语言 → Cypher → 图数据库（Neo4j）取关联知识

  * 适合多跳关系、隐含关系挖掘

---

## 6. 总结性视角

* 标准 RAG：能用
* 增强 RAG：围绕五条主线改造

  1. 评测体系
  2. 索引与检索
  3. 问题理解
  4. 纠偏检索
  5. 多源证据与自反思

---

## 你可以直接复用的“诊断表”

* 答非所问：优先做问题改写（Enrich, Step-back, Decomposition, Multi-Query）
* 查不到：优先做索引与切分、Embedding 与 ReRank、Top-K 与合并策略
* 说得像对但不可核验：加引用与证据约束，加 Self-RAG
* 知识库不完备：上 CRAG，引入外部检索
* 需要结构化事实：引入 NL2SQL 或图谱查询

如果你下一节要写“动手搭建 RAG 的操作步骤”，建议把步骤拆成：数据准备 → 文档解析与清洗 → chunk 策略 → embedding 与向量库 → 检索与 rerank → 提示词模板 → 引用展示 → 评测集与迭代。